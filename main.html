<!DOCTYPE html>
<html lang="en"> 
<head>
    <link rel="stylesheet" href="incl/main.css" type="text/css">
    <script type="text/javascript" src="incl/jquery-3.2.1.min.js"></script>
    <meta charset="UTF-8">
    <title>Fourth-Dimensional Pocket</title>  
</head>
<body>
    <header>Fourth-Dimensional Pocket</header>
    <div class="content">
        <nav class="menu">
            <p>Categories</p>
            <ul id="menuList"></ul>        
        </nav>
        <section>
                <section class="dropdown">

                        <button class="dropbtn">Shopping List $<span id = "totalbtn"></span></button>

                        <div class="dropdown-content">
                            <p>Shopping List ( Total:$<span id="totallist"></span>)</p>
                            <table id="shoppingList"></table>
                            <button>Checkout</button>        
                        </div>    

                </section>    
                <hr>
                <p id='path'></p>
                <ul id="products"></ul>
        </section>
    </div> 
<footer>Doraemon</footer>
<script type="text/javascript" src="incl/myLib.js"></script>
<script type="text/javascript">
(function(){

    function changeDetect(e){
                    id = e.target.id.replace(/^quantity/, '');
                    var total = localStorage.getItem('total');
                    var jsonData = JSON.parse(localStorage.getItem(id));
                    quantity = jsonData.value;
                    price = e.target.parentNode.querySelector('.price').innerHTML;
                    total -= Number(price) * Number(quantity);
                    if(e.target.value == 0){
                        localStorage.removeItem(id);
                        var str = "row"+id;
                        el(str).remove();
                    }
                    else{
                        total += Number(price) *  Number(e.target.value);
                        jsonData.value = e.target.value;
                        localStorage.setItem(id , JSON.stringify(jsonData));   
                    }
                    total = total.toFixed(1);
                    localStorage.setItem('total' , total);
                    el("totalbtn").innerHTML = Number(total);
                    el("totallist").innerHTML = Number(total);
    };

	function updateUI() {
		myLib.get({action:'cat_fetchall'}, function(json){
			// loop over the server response json
            //   the expected format (as shown in Firebug): 
			for (var listItems = [],i = 0, cat; cat = json[i]; i++) {
                listItems.push('<li id="cat',parseInt(cat.catid),'"><a href = "main.html?catid='+ parseInt(cat.catid) +'"><span class="name">',cat.name.escapeHTML(),'</span></a></li>');
			}
            el('menuList').innerHTML = listItems.join('');
            updateContent();
        });
        var total = localStorage.getItem('total');
        if(total){
            el("totalbtn").innerHTML = Number(total);
            el("totallist").innerHTML = Number(total);
            for(var i = 0; i < localStorage.length; i++) {
                if(localStorage.key(i) != 'total'){
                    var jsonData = JSON.parse(localStorage.getItem(localStorage.key(i)));
                    el("shoppingList").innerHTML += '<tr id="row'+jsonData.id+'" ><td>- '+jsonData.name.escapeHTML() +'</td> <td>Quantity: <input type="number" id="quantity'+jsonData.id+'"  class="quantity" min="0" value='+parseInt(jsonData.value) +'> @$<span class="price">'+Number(jsonData.price)+'</span></td></tr>';
                }
            }
            $(".quantity").change(function(e){changeDetect(e);});   
        }
        else{
            localStorage.setItem('total', 0);
            el("totalbtn").innerHTML = 0;
            el("totallist").innerHTML = 0;
        }
    }

    function updateContent() {
        var xmlHttp = new XMLHttpRequest();
        url = window.location.href;
        str = url.split('?catid=');
        catid = str[1];
        if(catid){ 
            xmlHttp.onreadystatechange = function() { 
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
                        el('products').innerHTML = "";
                        el('path').innerHTML = '<a href = "main.html">Home</a>  >  ';
                        var str = "cat"+catid;
                        var target = el(str);
                        name = target.querySelector('.name').innerHTML;
                        el('path').innerHTML += '<a href = "main.html?catid='+ catid +'">' + name.escapeHTML() + '</a>';  
                        result = xmlHttp.responseText.split('while(1);');
                        result = JSON.parse(result[1]);
                        result = result["success"];				
                        for (var listItems = [], i = 0, prod; prod = result[i]; i++) {
                            listItems.push('<li class="product-list" id= prod',parseInt(prod.pid),'><a href = "product.html?pid=',parseInt(prod.pid),'"><img src="incl/img/',parseInt(prod.pid),'.jpg"></img></a><a href = "product.html?pid=',parseInt(prod.pid),'"><p class = name>',prod.name.escapeHTML(),'</p></a><p>$ <span class = price>',Number(prod.price),'</span></p><button>Add to Cart</button></li>');
                        }
                        el('products').innerHTML = listItems.join('');
                    }	
                // populate the product list or navigate to admin.php?catid=<id>
            }
            xmlHttp.open("GET", "main.php?action=prod_fetchbycat&catid="+catid, true); // true for asynchronous 
            xmlHttp.send();
        }
        else{
            el('path').innerHTML = '<a href = "main.html">Home</a> > <a href = "main.html">All</a>';
            var xmlHttp = new XMLHttpRequest();
                xmlHttp.onreadystatechange = function() { 
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
            
                        result = xmlHttp.responseText.split('while(1);');
                        result = JSON.parse(result[1]);
                        result = result["success"];					
                        for (var listItems = [], i = 0, prod; prod = result[i]; i++) {
                            listItems.push('<li class="product-list" id= prod',parseInt(prod.pid),'><a href = "product.html?pid=',parseInt(prod.pid),'"><img src="incl/img/',parseInt(prod.pid),'.jpg"></img></a><a href = "product.html?pid=',parseInt(prod.pid),'"><p class= name>',prod.name.escapeHTML(),'</p></a><p>$ <span class = price>',Number(prod.price),'</span></p><button>Add to Cart</button></li>');
                        }
                        el('products').innerHTML = listItems.join('');
                    }	
                }
            xmlHttp.open("GET", "main.php?action=prod_fetchall", true); // true for asynchronous 
            xmlHttp.send();
        }    
    }
    updateUI();

    el('products').onclick = function(e) {
		if (e.target.tagName == 'BUTTON'){
		
		    var target = e.target,
			parent = target.parentNode,
			id = target.parentNode.id.replace(/^prod/, ''),
			name = target.parentNode.querySelector('.name').innerHTML;
            price = target.parentNode.querySelector('.price').innerHTML;
            var jsonData = JSON.parse(localStorage.getItem(id));
            var total = localStorage.getItem('total');
            if(jsonData){
                jsonData.value++;
                localStorage.setItem(id, JSON.stringify(jsonData));
                var str = "quantity"+id;
                el(str).value++; 
            }
            else{
                localStorage.setItem(id, JSON.stringify({id : id ,value : 1 ,name : name, price : price}));
                el("shoppingList").innerHTML += '<tr id="row'+id+'" ><td>- '+name.escapeHTML() +'</td> <td>Quantity: <input type="number" id="quantity'+id+'"  class="quantity" min="0" value=1> @$<span class="price">'+Number(price)+'</span></td></tr>';
                $(".quantity").change(function(e){changeDetect(e);});
            }
            total = Number(total) + Number(price);
            localStorage.setItem('total', total.toFixed(1));
            el("totalbtn").innerHTML =total.toFixed(1);
            el("totallist").innerHTML = total.toFixed(1);
            
        }
    }
    	
})();

</script>
</body>
</html>
